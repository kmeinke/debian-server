# Session Summary — 2026-02-18

## Salt-SSH Output & Secrets

- `show_changes: False` added to passwd.client to prevent SMTP credentials leaking in salt-ssh output
- `state_output: changes` added to salt/master to suppress no-op states from output
- salt-ssh has no streaming output by design — it collects everything and dumps at the end

## APT Hardening

- Disabled recommends and suggests system-wide via `/etc/apt/apt.conf.d/01norecommends` — eliminates unwanted dependencies like mariadb-common pulled by exim4
- Enforced permissions on APT trust chain directories (CIS 1.2.1): trusted.gpg.d, sources.list.d, auth.conf.d
- `/usr/share/keyrings` moved to security/pki.sls since it has broader scope than APT

## PKI & CA Trust Store

**Unresolved:** ssl-cert group/package — not installed, revisit if services need non-root access to private keys.

- New `security.pki` state enforces root ownership and permissions on the full certificate trust chain
- `/etc/ssl/private` set to root:root 0700 (not ssl-cert group, since package isn't installed)

## Login Banners & MOTD

- Duplicate MOTD fixed: sshd and PAM were both printing it; added `PrintMotd no` to sshd_config
- New `security.banners` state: empties `/etc/issue` and `/etc/issue.net` (CIS 1.7), manages MOTD
- MOTD state and template moved from monitoring/ to security/

## Shell Environment

- bashrc now deployed to `/root/.bashrc`, `/etc/skel/.bashrc`, and all pillar-defined user homes
- `peek` function moved from bashrc to `/usr/local/bin/peek` script so it works with plain `sudo`
- Added `man-db` to common packages

## System User Cleanup

**Unresolved:** exim4 depends on uucp user — can't remove it. `/etc/monit` directory comes from fail2ban, not a real monit install.

- Removed unused default Debian users: sync, games, lp, news, proxy, list, irc (CIS 7.2.1)
- Kept: man (man-db), backup, www-data, uucp (exim4 dependency)

## Test Runner Improvements

- Replaced fixed `time.sleep(3)` with socket polling loop that waits for sshd on port 2222
- Added elapsed time spinner during salt-ssh highstate run
- Fixed `cmd_ssh()`: split CLI args properly, expand `~` via `Path.home()`, added `StrictHostKeyChecking=no`

## Preflight Check

- New `base.preflight` state: fail-fast if secrets pillar is not loaded
- Runs first in top.sls (before any other states) via `failhard: True`
- Prevents partial highstate runs when secrets decryption was missed

## CRLF Issues

- Write tool on Windows creates CRLF files; salt-ssh deploys them as-is to Linux targets
- Broke the peek script (kernel couldn't find `/bin/bash\r`)
- Fixed with `sed -i 's/\r$//'; noted in memory for future sessions

## Documentation & Project Rules

- Added "do not trust by default" conversation rule to CLAUDE.md
- Added network/IP management decision to TODO.md (revisit at VM stage)
- Open decisions tracked in project TODO.md (noted in memory)

---

## Security Assessment (cyber-analyst)

**Unresolved:** Web server state and AppArmor are blocked on each other — AppArmor profiles are process-specific, web server must exist first.

A full security assessment of the base config was performed against CIS, NIST CSF, and MITRE ATT&CK. 14 gaps identified across HIGH / MEDIUM / LOW severity. 6 were resolved in this session, 6 deferred to TODO, 2 accepted as deliberate trade-offs (NOPASSWD sudo, SSH on port 22). The config was rated a solid medium-tier base requiring a web server state to be production-ready.

## PAM Hardening (`security/pam.sls`)

**Unresolved:** cgroup-based resource limits deferred — `nproc`/`nofile` via pam_limits skipped in favour of future systemd UMask/cgroup hardening per service.

New state managing 6 PAM files with CIS references throughout. Key controls: `pam_faillock` (3 attempts, 15-min lockout, `even_deny_root` intentionally off to protect console recovery), `pam_access` with admin hardcoded + pillar-loop for other users (protects against pillar render failure), `umask=0027` via `pam_umask`, `pam_lastlog`, `pam_nologin` (emergency lockout via `touch /etc/nologin`), dynamic motd suppressed in `pam-sshd`. The lockout attack surface was analyzed — remote brute-force is effectively blocked by the nftables rate limit → fail2ban → SSH MaxAuthTries → pam_faillock stack before PAM lockout is reachable.

## Firewall Hardening (nftables)

**Unresolved:** DNS egress restricted to Quad9 IPs only; SMTP egress restricted to smarthost IP only — both on TODO, require stable IPs.

Output chain flipped to default-drop with explicit egress allowlist (DNS 53, HTTPS 443, SMTP 465/587, NTP 123). ICMPv4 and ICMPv6 tightened from `accept all` to explicit operational type allowlists (echo, destination-unreachable, time-exceeded, parameter-problem) plus NDP types for IPv6. Port 80 egress removed — APT uses HTTPS only. SMTP allows both 465 (implicit TLS) and 587 (STARTTLS). Limitations of port-based egress filtering acknowledged — 443 C2 tunneling is not preventable at this layer; AppArmor and auditd are the real process-level controls.

## Docker Compatibility (`kernel:docker_host`)

Replaced three separate pillar flags (`ip_forward`, `blacklist_overlayfs`, implicit ARP settings) with a single `kernel:docker_host: False` boolean. When `True`: enables ip_forward, allows overlayfs, and skips Docker-incompatible sysctl hardening (`arp_filter`, `arp_ignore`, `drop_gratuitous_arp`). Single flag, clear intent, consistent with existing pillar pattern.

## ANSSI BP-028 Gap Analysis (sysctl)

Cross-referenced `99-hardening.conf` against ANSSI R9, R12, R14. Added: `tcp_rfc1337`, `ip_local_port_range`, `accept_local`, `shared_media`, `route_localnet`, `perf_cpu_time_max_percent`, `perf_event_max_sample_rate`, `fs.protected_fifos`, `fs.protected_regular`. Deliberately skipped `kernel.panic_on_oops=1` — on a single-instance server with no failover, an unplanned halt from a non-malicious oops is worse than a degraded-but-running kernel. Added to TODO for revisit when redundancy is available. ANSSI has no egress filtering recommendation — it defers network policy to companion documents.

## Contact Pillar & Banners

New `salt/pillar/contact.sls` with `company` and `security_email`. `/etc/issue.net` now rendered from a Jinja template with unauthorized access notice and responsible disclosure request. `/etc/motd.root` added — shown only on root login via bashrc, contains warning, FQDN, and `faillock` quick-reference commands. Root motd is `0640` (not world-readable).

## Monitoring Alerts (`monitoring/alerts.sls`)

Hourly cron job (`/etc/cron.hourly/journal-alert`) scans the last hour of journal for critical patterns: kernel oops/BUG/panic, hardware errors (MCE, EDAC), OOM kills, filesystem errors, segfaults in system processes. Sends mail to root (→ admin@example.com via exim4 aliases) with matches and system state snapshot. Capped at 100 lines to prevent mail floods. `kernel.panic_on_oops` was discussed and deliberately left off — the alert cron is the compensating control for oops detection.

## ANSSI Community Standing

Web search confirmed ANSSI BP-028 is internationally respected — shipped as SCAP content by Red Hat and SUSE, part of ComplianceAsCode alongside CIS and NIST. Viewed as more technically rigorous than CIS on kernel internals, less prescriptive than NIST at the framework level. Using CIS as compliance anchor + ANSSI as technical depth reference is considered best practice. `reference/awesome-security-hardening.md` added from GitHub.
