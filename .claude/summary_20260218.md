# Session Summary — 2026-02-18

## Salt-SSH Output & Secrets

- `show_changes: False` added to passwd.client to prevent SMTP credentials leaking in salt-ssh output
- `state_output: changes` added to salt/master to suppress no-op states from output
- salt-ssh has no streaming output by design — it collects everything and dumps at the end

## APT Hardening

- Disabled recommends and suggests system-wide via `/etc/apt/apt.conf.d/01norecommends` — eliminates unwanted dependencies like mariadb-common pulled by exim4
- Enforced permissions on APT trust chain directories (CIS 1.2.1): trusted.gpg.d, sources.list.d, auth.conf.d
- `/usr/share/keyrings` moved to security/pki.sls since it has broader scope than APT

## PKI & CA Trust Store

**Unresolved:** ssl-cert group/package — not installed, revisit if services need non-root access to private keys.

- New `security.pki` state enforces root ownership and permissions on the full certificate trust chain
- `/etc/ssl/private` set to root:root 0700 (not ssl-cert group, since package isn't installed)

## Login Banners & MOTD

- Duplicate MOTD fixed: sshd and PAM were both printing it; added `PrintMotd no` to sshd_config
- New `security.banners` state: empties `/etc/issue` and `/etc/issue.net` (CIS 1.7), manages MOTD
- MOTD state and template moved from monitoring/ to security/

## Shell Environment

- bashrc now deployed to `/root/.bashrc`, `/etc/skel/.bashrc`, and all pillar-defined user homes
- `peek` function moved from bashrc to `/usr/local/bin/peek` script so it works with plain `sudo`
- Added `man-db` to common packages

## System User Cleanup

**Unresolved:** exim4 depends on uucp user — can't remove it. `/etc/monit` directory comes from fail2ban, not a real monit install.

- Removed unused default Debian users: sync, games, lp, news, proxy, list, irc (CIS 7.2.1)
- Kept: man (man-db), backup, www-data, uucp (exim4 dependency)

## Test Runner Improvements

- Replaced fixed `time.sleep(3)` with socket polling loop that waits for sshd on port 2222
- Added elapsed time spinner during salt-ssh highstate run
- Fixed `cmd_ssh()`: split CLI args properly, expand `~` via `Path.home()`, added `StrictHostKeyChecking=no`

## Preflight Check

- New `base.preflight` state: fail-fast if secrets pillar is not loaded
- Runs first in top.sls (before any other states) via `failhard: True`
- Prevents partial highstate runs when secrets decryption was missed

## CRLF Issues

- Write tool on Windows creates CRLF files; salt-ssh deploys them as-is to Linux targets
- Broke the peek script (kernel couldn't find `/bin/bash\r`)
- Fixed with `sed -i 's/\r$//'; noted in memory for future sessions

## Documentation & Project Rules

- Added "do not trust by default" conversation rule to CLAUDE.md
- Added network/IP management decision to TODO.md (revisit at VM stage)
- Open decisions tracked in project TODO.md (noted in memory)
