# Session Summary — 2026-02-22

## Hetzner VM Test Runner

Added `scripts/test-vm.py` — a Hetzner Cloud VM test runner for higher-fidelity
testing (real kernel, real sysctl, real block devices, real apt). Complements the
Docker runner which remains the fast iteration tool.

- Creates a `cx22` VM in fsn1, waits for SSH
- Writes dynamic roster (`salt/roster-vm`, gitignored), decrypts secrets, runs highstate
- Cleans up roster and secrets on exit
- Uses `scripts/vm-userdata.yaml` for cloud-init bootstrap (admin user, SSH key, sudo)
- Config in `salt-vm/master` (separate from `salt/master` to keep PKI/cache isolated)

## Oracle OCI Test Runner

Added `scripts/test-vm-oci.py` — same pattern as Hetzner runner but targeting Oracle
Cloud free tier (VM.Standard.E2.1.Micro). Includes:

- `auth` command: verifies OCI key fingerprint and makes a live API call
- `upload-image` command: uploads Debian genericcloud qcow2 to Object Storage and
  imports as custom image
- Uses hardcoded OCIDs (compartment, image, subnet) — environment-specific, not secrets

## fstab State Removed

`base/fstab.sls` deleted and removed from `top.sls`. Partition layout is managed at
provisioning time (cloud-init / disk image). The genericcloud image has no separate
`/boot` — only `/` and `/boot/efi`. fstab is out of scope for Salt config management.

Compliance updated: R28 (ANSSI) marked N with explanation.

## Multi-Host Architecture Design

Discussed and agreed architecture for managing ~10 servers across OCI, IONOS, and
local targets:

- **Naming**: `<group>_<label>_<instance>` — group = customer, label = server role
  (no semantic convention), instance = failover index
- **Inventory**: one pillar file per logical server group (`pillar/hosts/kt_web.sls`),
  instances are an IP list within it — prevents drift between instances
- **Components**: pillar declares which components a host runs; dispatcher state
  (`host/init.sls`) includes the right states dynamically
- **Top file**: trivially `'*': [host]` — all targeting resolved at roster time
- **Roster**: custom external roster module (Python, reads pillar files) — Salt
  resolves targeting natively, no duplicate matching logic in wrapper scripts
- **Secrets**: layered — `secrets/hosts/<group_label>.sls.enc` and
  `secrets/components/<component>.sls.enc`

Implementation deferred to next session.
