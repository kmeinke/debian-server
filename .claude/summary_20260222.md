# Session Summary — 2026-02-22

## Hetzner VM Test Runner

Added `scripts/test-vm.py` — a Hetzner Cloud VM test runner for higher-fidelity
testing (real kernel, real sysctl, real block devices, real apt). Complements the
Docker runner which remains the fast iteration tool.

- Creates a `cx22` VM in fsn1, waits for SSH
- Writes dynamic roster (`salt/roster-vm`, gitignored), decrypts secrets, runs highstate
- Cleans up roster and secrets on exit
- Uses `scripts/vm-userdata.yaml` for cloud-init bootstrap (admin user, SSH key, sudo)
- Config in `salt-vm/master` (separate from `salt/master` to keep PKI/cache isolated)

## Oracle OCI Test Runner

Added `scripts/test-vm-oci.py` — same pattern as Hetzner runner but targeting Oracle
Cloud free tier (VM.Standard.E2.1.Micro). Includes:

- `auth` command: verifies OCI key fingerprint and makes a live API call
- `upload-image` command: uploads Debian genericcloud qcow2 to Object Storage and
  imports as custom image
- Uses hardcoded OCIDs (compartment, image, subnet) — environment-specific, not secrets

## fstab State Removed

`base/fstab.sls` deleted and removed from `top.sls`. Partition layout is managed at
provisioning time (cloud-init / disk image). The genericcloud image has no separate
`/boot` — only `/` and `/boot/efi`. fstab is out of scope for Salt config management.

Compliance updated: R28 (ANSSI) marked N with explanation.

## Multi-Host Architecture Design

Discussed and agreed architecture for managing ~10 servers across OCI, IONOS, and
local targets:

- **Naming**: `<group>_<label>_<instance>` — group = customer, label = server role
  (no semantic convention), instance = failover index
- **Inventory**: one pillar file per logical server group (`pillar/hosts/kt_web.sls`),
  instances are an IP list within it — prevents drift between instances
- **Components**: pillar declares which components a host runs; dispatcher state
  (`host/init.sls`) includes the right states dynamically
- **Top file**: trivially `'*': [host]` — all targeting resolved at roster time
- **Roster**: custom external roster module (Python, reads pillar files) — Salt
  resolves targeting natively, no duplicate matching logic in wrapper scripts
- **Secrets**: layered — `secrets/hosts/<group_label>.sls.enc` and
  `secrets/components/<component>.sls.enc`

Implementation started next session — see revised architecture below.

## Multi-Host Implementation (continued from earlier session)

The initial architecture was revised during implementation based on user feedback:
the dynamic Jinja dispatcher and `components` pillar key were dropped in favour of
Salt's native `top.sls` glob targeting, which already handles per-host state selection.

### What was implemented

**Pillar restructure:**
- `pillar/defaults/<domain>.sls` — 11 files, base values applied to all hosts via `'*'`
- `pillar/hosts/<group>.sls` — per-group overrides, deep-merged by Salt automatically
- `pillar/secrets/hosts/<group>.sls.enc` — one SOPS-encrypted secrets file per group
- All three test hosts (`test_docker`, `test_hetzner`, `test_oci`) have `hosts/` and `secrets/hosts/` entries

**State restructure:**
- `secure_linux/init.sls` — new umbrella state with a static `include:` list of all hardening substates
- `states/top.sls` simplified to `'*': [secure_linux]`; per-group extras added by minion ID glob as needed

**Test runner updates (all three runners):**
- Minion IDs renamed: `test_docker_1`, `test_hetzner_1`, `test_oci_1`
- `glob()` → `rglob()` for secret decrypt/cleanup (secrets now in subdirectory)
- `check` command added: applies only `base.hostname` (~10s) for fast smoke testing
- `run_with_spinner()` made generic with a `label` parameter

**Verification:** `./scripts/test-docker.py check` — 3 states, 0 failures, hostname
resolves to `test-docker-1` (confirming pillar override working).

## nginx State (www/nginx)

Added a hardened nginx base configuration as `salt/states/www/nginx/` (directory layout
anticipating future `apache2/`, `certbot/` siblings).

- Installs nginx, creates `/srv/www` document root
- Hardened `nginx.conf`: TLS 1.3 only, `server_tokens off`, OCSP stapling, JSON access
  logging, conservative timeouts, `client_max_body_size 1m`
- Default catch-all site rejects unknown vhosts: HTTP returns 444, HTTPS uses
  `ssl_reject_handshake on`
- DNS resolver sourced from `network:nameservers` pillar; log level from `nginx:log_level`
- `/etc/nginx` permissions: `0750` dir, `0640` files (CIS 2.3.1-2.3.2)

## Docker Networking / APT Failures

Debugged persistent APT failures (`Temporary failure resolving 'deb.debian.org'`) in the
Docker test container after applying hardening states.

- Root cause: `net.ipv4.conf.all.route_localnet = 0` sysctl (set by `security/sysctl.sls`)
  blocks Docker's embedded DNS NAT rule redirecting `127.0.0.11:53`
- Fix: `kernel.docker_host: True` pillar key in `hosts/test_docker.sls` gates the
  `route_localnet` sysctl so it is not applied inside Docker
- Also added `ip daddr 127.0.0.0/8 accept` to nftables output chain to allow loopback
  DNS traffic
- MTU mismatch (`com.docker.network.driver.mtu: "1450"`) added to docker-compose as a
  precaution against HTTPS stalls on some host network configurations

## Test Runner Output Improvements

Replaced raw salt-ssh output (hundreds of lines) with a compact summary line:

- Full output written to `.salt/tmp/salt-ssh-<timestamp>.log` for debugging
- Terminal shows only: `✓  succeeded=N, changed=N  — log: <path>` (or `✗` with failed IDs)
- Spinner shows elapsed time while salt-ssh runs
- `check` command accepts an optional state argument (default: `base.hostname`)
- No-argument invocation now shows help instead of defaulting to `test`

## Idempotency Audit

Audited all states for non-idempotent behaviour (reporting `changed` on clean re-runs).

- **Root cause pattern**: `file.directory` with `recurse: [user, group, mode]` overrides
  per-file modes set by `file.managed` states, causing every run to "fix" them back,
  which in turn triggers `watch_in` service restarts
- **Fix**: remove `mode` from `recurse`; use only `user`/`group` to enforce ownership
  recursively; rely on `file_mode` for the directory default only
- **Fixed**: `apt/init.sls` (3 dirs), `security/pki.sls` (3 dirs), `www/nginx/init.sls`
- **boot.sls**: `cmd.run` states guarded with `unless` — checks whether any files already
  have wrong owner/group/permissions before running `find+chmod`; `file.directory` recurse
  not usable here because `/boot` contains subdirs with legitimately different permissions
  and Salt has no depth limit on recurse

## systemd-timesyncd Container Fix

`systemd-timesyncd` has `ConditionVirtualization=!container` built in, causing it to
fail to start (not just skip) on second run inside Docker. Fixed by adding
`! systemd-detect-virt --container -q` to the `onlyif` guard so Salt doesn't attempt
to manage the service at all inside containers.
