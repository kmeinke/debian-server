# Session Summary 2026-02-15

## Docker Testing Infrastructure Overhaul

**Unresolved:**
- None

Replaced the original `test.sh` (which ran salt-call directly as PID 1) with a systemd-based Docker setup. The container now boots systemd via `/sbin/init`, enabling full testing of services, timers, and hostname. Required `cgroup: host`, `privileged: true`, and tmpfs mounts for `/run` and `/run/lock` in docker-compose.yml. The test script was simplified to four commands: `build`, `shell`, `test`, `clean`.

## Salt State Fixes

**Unresolved:**
- None

Fixed `locale.sls` — the `locale.system` state failed with a grep error because `/etc/default/locale` didn't exist in minimal Debian Docker images. Solved by seeding the file with `LANG=<locale>` before the `locale.system` state runs.

Converted APT sources from old one-line format (`sources.list`) to DEB822 format (`debian.sources` in `sources.list.d/`). The old `sources.list` conflicted with Bookworm's default `debian.sources`, causing duplicate source warnings. The Salt repo in the Dockerfile was also converted to DEB822.

Added `iproute2` and `bash-completion` to the Dockerfile since Salt needs `ip` for network grains and tab completion was missing.

## Bash Configuration

**Unresolved:**
- None

Added a `peek` helper function to the system-wide `bash.bashrc`: auto-detects target type and runs `ls -la` for directories, `less -S` for text files, or `zless` for gzip files.

## Line Endings

**Unresolved:**
- None

Fixed CRLF line endings across the entire repo. Added `.gitattributes` with `* text=auto eol=lf` and renormalized all working copies to LF.

## Project Tooling Setup

**Unresolved:**
- None

Created `CLAUDE.md` with project conventions, salt patterns, testing workflow, and conversation rules (no auto-commits, review changes before committing, don't imply implementation from questions). Zed AI panel rules were confirmed to be separate from Claude Code — CLAUDE.md is the equivalent for Claude Code sessions.

## CIS 6.1 — Logging (rsyslog to journald)

**Unresolved:**
- Remote logging (CIS 6.1.3.6) deferred to TODO
- auditd (CIS 6.2) deferred to TODO

Determined that rsyslog is unnecessary for a journald-only setup — nginx, MySQL, PHP-FPM all support journald natively. Repurposed `rsyslog.sls` to actively purge the rsyslog package (user explicitly wanted the file kept, not deleted). Created `journald.sls` deploying hardened journald config: persistent storage, compression, ForwardToSyslog=no, rotation limits. Journal directory permissions set to 2750 root:systemd-journal. All rotation limits exposed as pillar values in `logging.sls`.

## CIS 7.1/7.2 — System File Permissions & User Settings

**Unresolved:**
- 7.1.11–7.1.13 — World-writable, unowned, SUID/SGID file audits (periodic, added to TODO)
- 7.2.1–7.2.8 — User/group integrity audits (periodic, added to TODO)

Created `security/etc-passwd.sls` enforcing permissions on authentication files: passwd/group (0644 root:root), shadow/gshadow (0640 root:shadow), opasswd (0600 root:root). Originally named `permissions.sls` but renamed after discussing that CIS 7.1 is specifically about auth files, not general /etc permissions. The `/etc/shells` permission enforcement was moved to `shell/bash.sls` as it fits better thematically. Added home directory permission enforcement (0750) to `users.sls` and CIS reference comments to `users.sls` and `sudo.sls`.

Researched /etc permissions beyond CIS (DISA STIG, ANSSI, BSI, Debian Policy). Key insight: the per-service approach (SSH, cron, sudo each managing their own file permissions) is the correct pattern. Root should own all /etc config files; services should only have read access. Default 0644 is correct for non-sensitive files; only files containing secrets need individual restriction.

## Log Retention Policy

**Unresolved:**
- nginx, MySQL, PHP log rotation will be handled by future per-service states

Researched log retention guidelines across CIS (90 days), BSI (90 days), ANSSI (365 days), PCI DSS (365 days). Established a three-tier retention model:

- **journald** (system + security layer): 180 days, 1GB cap — covers auth, kernel, systemd, fail2ban
- **logrotate** (service logs): 90 days, daily, compressed — global default for anything not covered by package-specific configs
- **Package-managed** (apt, dpkg, exim4): left at their own defaults

Redirected fail2ban logging from file-based (`/var/log/fail2ban.log`) to journald via `logtarget = SYSTEMD-JOURNAL`, since it's a security daemon that belongs in the system layer. All retention values exposed in `pillar/logging.sls`.

## Reference Documents

**Unresolved:**
- None

Added CIS benchmarks (Debian 13, NGINX v3.0.0, MariaDB 10.11, PostgreSQL 17, Apache 2.4, FreeBSD 14) and ANSSI Linux hardening guide as PDFs in `reference/`. Added conversation rule to CLAUDE.md: check reference directory before searching the web.
