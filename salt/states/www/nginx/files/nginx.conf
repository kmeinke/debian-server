user www-data;
worker_processes auto;

error_log /var/log/nginx/error.log {{ log_level }};
pid /run/nginx.pid;

include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    # Hide nginx version (CIS 2.5.1)
    server_tokens off;

    # Timeouts (CIS 2.4.3, 2.4.4, 5.2.1)
    keepalive_timeout       10;
    send_timeout            10;
    client_header_timeout   15;
    client_body_timeout     15;

    # Request limits (CIS 5.2.2, 5.2.3)
    client_max_body_size        1m;
    large_client_header_buffers 4 8k;

    # TLS defaults (CIS 4.1.4, 4.1.5)
    ssl_protocols           TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_session_tickets     on;

    # OCSP stapling (CIS 4.1.7)
    ssl_stapling            on;
    ssl_stapling_verify     on;
    ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
    resolver                {{ nameservers }} valid=300s;
    resolver_timeout        5s;

    # MIME types
    include      /etc/nginx/mime.types;
    default_type application/octet-stream;

    sendfile    on;
    tcp_nopush  on;

    # Logging (CIS 3.1, 3.2, 3.3)
    log_format main_json escape=json
        '{'
        '"timestamp":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"server_name":"$server_name",'
        '"request_method":"$request_method",'
        '"request_uri":"$request_uri",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"x_forwarded_for":"$http_x_forwarded_for"'
        '}';

    access_log /var/log/nginx/access.log main_json;

    include /etc/nginx/sites-enabled/*;
}
