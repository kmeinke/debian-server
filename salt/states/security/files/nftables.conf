#!/usr/sbin/nft -f
{% set fw = salt['pillar.get']('firewall', {}) %}
{% set ssh_port = salt['pillar.get']('ssh:port', 22) %}
{% set tcp_ports = fw.get('tcp_ports', [ssh_port, 80, 443]) %}
{% set egress = fw.get('egress', {}) %}
{% set egress_tcp = egress.get('tcp_ports', [53, 80, 443, 587]) %}
{% set egress_udp = egress.get('udp_ports', [53, 123]) %}

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Allow loopback
        iif "lo" accept

        # Allow established/related
        ct state established,related accept

        # Drop invalid
        ct state invalid drop

        # Allow ICMPv4 — operational types only
        ip protocol icmp icmp type {
            echo-request,
            echo-reply,
            destination-unreachable,
            time-exceeded,
            parameter-problem
        } accept

        # Allow ICMPv6 — NDP (RFC 4861) + echo + diagnostics
        ip6 nexthdr icmpv6 icmpv6 type {
            nd-router-solicit,
            nd-router-advert,
            nd-neighbor-solicit,
            nd-neighbor-advert,
            nd-redirect,
            echo-request,
            echo-reply,
            destination-unreachable,
            time-exceeded,
            parameter-problem
        } accept

        # Allow configured TCP ports
        {% for port in tcp_ports %}
        tcp dport {{ port }} ct state new accept
        {% endfor %}

        # Rate limit new SSH connections
        tcp dport {{ ssh_port }} ct state new limit rate 4/minute accept

        # Log and drop everything else
        log prefix "nftables-drop: " counter drop
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
    }

    chain output {
        type filter hook output priority 0; policy drop;

        # Allow loopback
        oif "lo" accept

        # Allow established/related (responses to inbound connections)
        ct state established,related accept

        # Drop invalid
        ct state invalid drop

        # Allow ICMPv4 outbound — operational types only
        ip protocol icmp icmp type {
            echo-request,
            echo-reply,
            destination-unreachable,
            time-exceeded,
            parameter-problem
        } accept

        # Allow ICMPv6 outbound — NDP (RFC 4861) + echo + diagnostics
        ip6 nexthdr icmpv6 icmpv6 type {
            nd-router-solicit,
            nd-router-advert,
            nd-neighbor-solicit,
            nd-neighbor-advert,
            nd-redirect,
            echo-request,
            echo-reply,
            destination-unreachable,
            time-exceeded,
            parameter-problem
        } accept

        # Allow egress TCP (DNS, HTTPS for apt, SMTP relay)
        {% for port in egress_tcp %}
        tcp dport {{ port }} accept
        {% endfor %}

        # Allow egress UDP (DNS, NTP)
        {% for port in egress_udp %}
        udp dport {{ port }} accept
        {% endfor %}

        # Log and drop everything else
        log prefix "nftables-drop-out: " counter drop
    }
}
